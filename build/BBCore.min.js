/*! BBCore 2018-11-30 */
function BBCore(a){this.userEmail="",this.userId="",this.clientId="",this.accessToken="",this.currentVideoId=null,this.email=null,this.apiServer=null,this.credentials={clientIdentifier:null,redirectUri:null,clientSecret:null,type:"implicit"},this.onerror=null,this.__mergeProperties(null,a),this.authenticated=!1,this.hasContext=!1,this.storage=localStorage||window.storage,this.CONTENT={QUICKSEND:""},this.lastresponse="",this.__vidRecording=!1,this.__vidRecHndl=null,this.contacts=function(){console.warn("running this.contacts!")},this.contacts.prototype=Object.create(Array.prototype),this.contacts.constructor=this.contacts,this.contacts.prototype.add=function(a){return this.push(a),this},this.contacts.prototype.find=function(a,b){for(var c in this)if(this.hasOwnProperty(c)&&c[a]===b)return c;return null},this.contacts.prototype.get=function(a){return this.find("id",a)},this.videos=function(){},this.videos.prototype=Object.create(Array.prototype),this.videos.constructor=this.videos,this.videos.prototype.add=function(a){return this.push(a),this},this.accessToken&&this.validateAccessToken(),this.email&&this.password&&this.login(this.email,this.password)}function responseSuccess(a,b){}"function"!=typeof Object.create&&(Object.create=function(a,b){function c(){}if("object"!=typeof a&&"function"!=typeof a)throw new TypeError("Object prototype may only be an Object: "+a);if(null===a)throw new Error("This browser's implementation of Object.create is a shim and doesn't support 'null' as the first argument.");if(void 0!==b)throw new Error("This browser's implementation of Object.create is a shim and doesn't support a second argument.");return c.prototype=a,new c}),BBCore.CONFIG={VERSION:"1.0",API_END_POINT:"/app/api/api.php",SERVER_API_URL:"https://app.bombbomb.com",OAUTH_STORAGE:"authToken"},BBCore.prototype.__mergeProperties=function(a,b){a||(a=this);for(var c in b)c&&b.hasOwnProperty(c)&&(a[c]=a[c]&&"object"==typeof a[c]?this.__mergeProperties(a[c],b[c]):b[c]);return a},BBCore.prototype.onError=function(a,b){"function"==typeof a?this.onerror=a:this.onerror&&this.onerror.call(this,a,b)},BBCore.prototype.ver=function(){return BBCore.CONFIG.VERSION},BBCore.prototype.login=function(a,b,c){if(arguments.length<2&&this.credentials&&this.credentials.clientIdentifier){var d=window;"undefined"!=typeof usePopup&&(d=window.open("about:blank","_blank")),d.location=this.getOAuthUrl()}else{if("function"==typeof a&&(c=a,a=this.storage.getItem("b2-uid"),b=this.storage.getItem("b2-pwd")),!a&&!this.accessToken)return void this.onError({info:{errormsg:"Username cannot be blank"}});this.userEmail=a;var e=this;this.sendRequest({method:"ValidateSession",email:a,pw:b,jwt:!0},function(a){e.__updateSession(a,c)})}},BBCore.prototype.logout=function(){this.clearJsonWebToken(),this.clearOAuthToken(),this.clearKey(),this.storage.removeItem("b2-uid"),this.storage.removeItem("b2-pwd"),this.accessToken="",this.hasContext=!1,this.authenticated=!1},BBCore.prototype.credentialsSaved=function(){return null!==this.storage.getItem("b2-uid")||null!==this.storage.getItem("access_token")||null!==this.storage.getItem("jsonWebToken")||null!==localStorage.getItem("authToken")},BBCore.prototype.saveCredentials=function(a,b){this.storage.setItem("b2-uid",a)},BBCore.prototype.validateSession=function(a,b){var c=this.getOAuthPayload(),d=this,e=/[\?\#].*&*(access_token|code)=([^&]+)/gi.exec(window.location);if(e&&e.length>1){var f=e[2];if("code"===e[1])this.validateOAuthCode(decodeURIComponent(f),function(a){this.storeOAuthTokens(a),window.location.href="?code"===e[0].substr(0,5)?window.location.href.replace("?code="+f,""):window.location.href.replace("&code="+e[1],"")},b);else{for(var g={access_token:f,token_type:null,expires_in:null},h=window.location.hash.replace("access_token="+f,""),i=null;i=/\&*(token_type|expires_in)=([^&]+)/gi.exec(window.location.hash);)g[i[1]]=i[2],h=h.replace(i[0],""),window.location.hash=h.length>1?h:"";this.authenticated=!0,this.storeOAuthTokens(g),a.call(d)}}else if(this.isOAuthTokenValid(c)){var j=this.__getOAuthAccessPayload(c);this.__updateSession({status:"success",info:{clientId:j.bbcid,userId:j.sub}},function(){a.call(d)})}else!this.getKey()&&this.getJsonWebToken()?this.verifyJsonWebToken(function(b){d.__updateSession(b),a.call(d,b)}):this.credentials&&this.credentials.clientIdentifier?b&&b():this.getKey()?this.validateAccessToken(a):this.storage.getItem("b2-uid")?this.login(a):b&&b()},BBCore.prototype.getOAuthUrl=function(){var a=null,b=this.credentials;return b.clientIdentifier&&b.redirectUri&&(a=this.getServerUrl()+"/auth/authorize?client_id="+b.clientIdentifier+"&scope="+encodeURIComponent(b.scope?b.scope:"all:manage")+"&redirect_uri="+encodeURIComponent(b.redirectUri)+"&response_type="+("implicit"===b.type?"token":"code")),a},BBCore.prototype.resumeStoredSession=BBCore.prototype.validateSession,BBCore.prototype.validateAccessToken=function(a){var b=this;this.sendRequest({method:"ValidateSession",api_key:this.accessToken,async:!1,jwt:!0},function(c){b.__updateSession(c,a)})},BBCore.prototype.isAuthenticated=function(){return this.authenticated||console.log("You must authenticate a BombBomb session before making additional calls."),this.authenticated},BBCore.prototype.invalidateSession=function(){try{this.logout()}catch(a){return!1}return!0},BBCore.prototype.__updateSession=function(a,b){"success"===a.status&&(a.info.userId?(this.userId=a.info.userId,this.clientId=a.info.clientId):(this.userId=a.info.user_id,this.clientId=a.info.client_id),a.info.api_key&&(this.accessToken=a.info.api_key),this.hasContext=!0,this.authenticated=!0,this.storeKey(this.accessToken),this.storeJsonWebToken(a.info.jwtoken),console.log("bbcore: __updateSession session updated."),b&&b.call(this,a))},BBCore.prototype.verifyKey=function(a,b){this.sendRequest({method:"GetEmails",api_key:a},function(a){b&&b({isValid:"success"===a.status})})},BBCore.prototype.storeKey=function(a){a&&(this.accessToken=a,this.storage.setItem("access_token",this.accessToken))},BBCore.prototype.getKey=function(){return this.accessToken?this.accessToken:this.storage.getItem("access_token")},BBCore.prototype.clearKey=function(){this.accessToken=null,this.storage.removeItem("access_token")},BBCore.prototype.verifyJsonWebToken=function(a,b){"function"==typeof a&&(b=a,a=this.getJsonWebToken()),this.sendRequest({method:"ValidateJsonWebToken",jwt:a},function(a){b&&(a.isValid="success"===a.status,b(a))})},BBCore.prototype.storeOAuthTokens=function(a){if(a)try{a="string"==typeof a?a:JSON.stringify(a),this.storage.setItem(BBCore.CONFIG.OAUTH_STORAGE,btoa(a))}catch(a){}},BBCore.prototype.getOAuthPayload=function(){var a=this.storage.getItem(BBCore.CONFIG.OAUTH_STORAGE);return a?atob(a):null},BBCore.prototype.getOAuthTokenForRequest=function(){var a=null;try{var b=this.getOAuthPayload();if(b&&this.isOAuthTokenValid(b)){var c=JSON.parse(b);"object"==typeof c&&(a=c.token_type.substr(0,1).toUpperCase()+c.token_type.substr(1)+" "+c.access_token)}}catch(a){console.error("Exception occurred retrieving OAuth Token for Request",a)}return a},BBCore.prototype.clearOAuthToken=function(){this.authenticated=!1,this.storage.removeItem(BBCore.CONFIG.OAUTH_STORAGE)},BBCore.prototype.__getOAuthAccessPayload=function(a){var b="string"==typeof a?JSON.parse(a):a,c=null;if(b)try{var d=b.access_token.split(".");d.length>2&&(c=JSON.parse(atob(d[1])))}catch(a){console.warn("Exception __getOAuthAccessPayload fetching access_token payload",a)}return c},BBCore.prototype.isOAuthTokenValid=function(a){var b=!1;try{var c=this.__getOAuthAccessPayload(a);c&&new Date(c.exp)<Date.now()&&(b=!0)}catch(a){console.warn("Exception while validating OAuthToken",a)}return b},BBCore.prototype.validateOAuthCode=function(a,b,c){var d=this,e=this.credentials,f={url:this.getServerUrl()+"/auth/access_token",grant_type:e.type||"implicit",client_id:e.clientIdentifier,redirect_uri:e.redirectUri,code:JSON.stringify(a)};if("implicit"!==e.type){if(!e.clientSecret||!e.clientSecret){var g="Client Secret required when making "+e.type+" grant requests";return console.warn(g),void c.call(this,g)}f.client_secret=e.clientSecret}this.sendRequest(f,function(a){a&&this.isOAuthTokenValid(a)?(this.authenticated=!0,this.storeOAuthTokens(a),b&&b.call(d)):c&&c.call(d)})},BBCore.prototype.refreshOAuthToken=function(a){var b=this.credentials,c={url:this.getServerUrl()+"/auth/access_token",grant_type:"refresh_token",refresh_token:this.getOAuthRefreshToken(),client_id:b.clientIdentifier,client_secret:b.clientSecret,redirect_uri:b.redirectUri,code:JSON.stringify(authCode)};this.sendRequest(c,function(b){console.log("got refresh auth back",b),b&&(this.isOAuthTokenValid(b)&&(this.authenticated=!0),this.storeOAuthTokens(b),a&&a())})},BBCore.prototype.storeJsonWebToken=function(a){a&&(this.jsonWebToken=a,this.storage.setItem("jsonWebToken",this.jsonWebToken))},BBCore.prototype.getJsonWebToken=function(){return this.jsonWebToken?this.jsonWebToken:this.storage.getItem("jsonWebToken")},BBCore.prototype.clearJsonWebToken=function(){this.jsonWebToken=null,this.storage.removeItem("jsonWebToken")},BBCore.prototype.getValidJsonWebTokenAsync=function(a){var b=this.getJsonWebToken();if(!b&&a)return void a(null);this.verifyJsonWebToken(b,function(c){c&&c.isValid?a&&a(b):this.validateAccessToken(function(b){a&&(c?(this.storeJsonWebToken(b.jwtoken),a(this.getJsonWebToken())):a(null))})})},BBCore.prototype.getServerUrl=function(){return this.apiServer||BBCore.CONFIG.SERVER_API_URL},BBCore.prototype.getRequestUrl=function(){return this.getServerUrl()+BBCore.CONFIG.API_END_POINT},BBCore._addParameterToUrl=function(a,b,c){var d="?";return-1!==a.indexOf("?")&&(d="&"),a+d+b+"="+c},BBCore.prototype.sendRequest=function(a,b,c,d){if("function"==typeof b&&(c=b),"object"==typeof a&&(b=a),"object"==typeof a&&b.method&&(a=b.method),"string"!=typeof a||b.method||(b.method=a),"IsValidLogin"===a||b.api_key||(b.api_key=this.getKey()),"ValidateSession"!==a&&"authorization_code"!==b.grant_type&&!this.authenticated)return this.onError.call(this,{status:"failure",methodName:"InvalidSession",info:{errormsg:"Invalid login"}},null),!1;var e={},f=this,g=!0;void 0!==b.async&&(g=b.async);var h=this.getOAuthTokenForRequest(),i=this.getJsonWebToken();h&&h.length?(e.Authorization=h,void 0!==b.api_key&&delete b.api_key):i&&i.length&&(e["BB-JWT"]=i);var j=b.url?b.url:this.getRequestUrl();return j=BBCore._addParameterToUrl(j,"xsrc","bbcore-"+BBCore.CONFIG.VERSION),jQuery.ajax({url:j,async:g,type:"post",dataType:"json",crossDomain:!0,data:b,headers:e,success:function(d){f.lastresponse=d.status,"success"===d.status?("GetVideoGuid"===a&&d.info&&d.info.video_id&&(f.currentVideoId=d.info.video_id),c&&c.call(f,d)):"authorization_code"===b.grant_type||"refresh_token"===b.grant_type?c.call(f,d):f.onError.call(f,d)},error:function(a){var b={status:"unknown",jqXHR:a};void 0!==a.responseJSON&&(b=a.responseJSON),f.lastresponse=b.status,"success"===b.status?c.call(f,b,a):f.onError.call(f,b,a),d&&d(f,b)}})},BBCore.prototype.getLists=function(a){this.sendRequest({method:"GetLists"},a)},BBCore.prototype.createList=function(a,b){this.sendRequest({method:"createList",name:a},b)},BBCore.prototype.getContact=function(a,b){if(a){var c={width:340,force_ssl:!1},d=jQuery.extend({},c,{contact_id:a,method:"GetContact"});this.sendRequest(d,b)}},BBCore.prototype.getListContacts=function(a,b){a&&this.sendRequest({method:"GetListContacts",list_id:a},b)},BBCore.prototype.addContact=function(a,b){"object"==typeof a&&(a.method="AddContact",this.sendRequest(a,b))},BBCore.prototype.bulkAddContacts=function(a,b){a||(a={}),a.method="BulkAddContacts","object"==typeof a.contacts&&(a.contacts=JSON.stringify(a.contacts)),this.sendRequest(a,b)},BBCore.prototype.updateContact=function(a,b){a&&(a.method="UpdateContact",this.sendRequest(a,b))},BBCore.prototype.getImportAddressesByType=function(a,b){a=jQuery.extend({method:"getImportAddressesByType"},a),a.type||this.onError({info:{errmsg:["A Type must be provided."]}}),this.sendRequest(a,b)},BBCore.prototype.addContactImportAddress=function(a,b){a=jQuery.extend({method:"addContactImportAddress"},a),a.importAddrCode&&a.importAddrName||this.onError({info:{errmsg:["An Import Address Code and Import Address Name must be provided."]}}),this.sendRequest(a,b)},BBCore.prototype.deleteContactImportAddress=function(a,b){a=jQuery.extend({importAddrCode:1,method:"deleteContactImportAddress"},a),a.importAddrCode||this.onError({info:{errmsg:["Invalid Import Address Code"]}}),this.sendRequest(a,b)},BBCore.prototype.getClientRecentInteractions=function(a,b){a=a||{},a.activitySince=a.activitySince||"",a.method="GetClientRecentInteractions",this.sendRequest(a,b)},BBCore.prototype.getEmails=function(a){this.sendRequest({method:"GetEmails"},a)},BBCore.prototype.sendCustomVideoEmail=function(a,b){var c={method:"SendCustomVideoEmail",html_content:null,subject:"",email:"",email_id:"",from_name:""},d=jQuery.extend({},c,a);this.sendRequest(d,b)},BBCore.prototype.getDrips=function(a,b){a=a||{},a.method="GetDrips",this.sendRequest(a,b)},BBCore.prototype.getForms=function(a,b){a=a||{},a.method="GetForms",this.sendRequest(a,b)},BBCore.prototype.getClientIntegrations=function(a,b){"function"==typeof a&&(b=a,a={}),a.method="getClientIntegrations",this.sendRequest(a,b)},BBCore.prototype.getEmbeddedRecorderUrl=function(a,b){"function"==typeof a&&(b=a,a={});var c={height:240,width:320,force_ssl:!1};void 0===a.height&&(a=jQuery.extend({},c,a||{}));var d=jQuery.extend({},a,{module:"videos",page:"EmbeddedRecorder",popup:1,nohtml:1}),e=this;this.getVideoId(function(c){var f=e.getServerUrl()+"/app/?",g=e.getKey();ignoreLegacyToken=a.ignoreLegacyToken||!1,g&&g.length&&!ignoreLegacyToken?(d.api_key=g,f+="module=login&actn=login&api_key="+g+"&redir="+btoa(f+jQuery.param(d)+(c?"&vguid="+c:"")),b.call(this,{url:f,video_id:c})):(a.videoId=c,this.getVideoRecorder(a,function(a){var d="";if(a&&a.info&&a.info.content.length){d=/https*:\/\/[^<"]+/.exec(a.info.content)[0]}b({url:d,video_id:c})}))})},BBCore.prototype.getVideoRecorder=function(a,b){"function"==typeof a&&(b=a,a=null);var c={height:240,width:320,force_ssl:!1,start:null,stop:null,recorded:null};if(mergedOpts=jQuery.extend(c,a),!this.isAuthenticated())return void this.onError({message:"Must authenticate session before invoking methods."});mergedOpts.method="GetVideoRecorder",this.sendRequest(mergedOpts,function(a){b&&b.call(this,a)})},BBCore.prototype.startVideoRecorder=function(a,b){"function"==typeof a&&(b=a,a=null);var c={type:"embedded",target:null,height:240,width:320,force_ssl:!1,recorderLoaded:null,recordComplete:b};a=a||c,a.recordComplete&&!b&&(b=a.recordComplete),this.__vidRecHndl=a.target?jQuery(a.target):jQuery("body").append('<div id="b2recorder"></div>');var d=jQuery.extend({},a);delete d.type,delete d.target,delete d.recordComplete,delete d.recorderLoaded;var e=this;this.getVideoRecorder(d,function(b){!e.currentVideoId&&b.info.vid_id&&(e.currentVideoId=b.info.vid_id),console.log("startVideoRecorder :"+e.currentVideoId),e.__vidRecHndl.html(b.info.content),a.recorderLoaded&&a.recorderLoaded.call(e,b.info)}),window.bbStreamStartRecord=function(a,b){console.log("bbStreamStartRecord triggered"),e.liveStreamStartRecord.call(e,a,b)},window.bbStreamStopRecord=function(a){console.log("bbStreamStopRecord triggered"),e.liveStreamStopRecord.call(e,a)},window.reportVideoRecorded=function(a,c){console.log("reportVideoRecorded triggered"),b({videoId:e.currentVideoId,filename:a,log:c})}},BBCore.prototype.destroyVideoRecorder=function(){void 0!==this.__vidRecHndl&&this.__vidRecHndl.remove(),window.bbStreamStartRecord=null,window.bbStreamStopRecord=null,window.reportVideoRecorded=null},BBCore.prototype.liveStreamStartRecord=function(a,b){this.__vidRecording=!0,this.sendRequest({method:"liveStreamStartRecord",streamname:a,filename:b})},BBCore.prototype.liveStreamStopRecord=function(a){this.__vidRecording=!1,this.sendRequest({method:"liveStreamStopRecord",streamname:a})},BBCore.prototype.saveRecordedVideo=function(a,b,c,d){var e=b||this.currentVideoId,f=this;this.sendRequest({method:"VideoRecordedLive",title:a,filename:c,vid_id:e},function(a){d.call(f,a)})},BBCore.prototype.saveRecording=function(a){var b=a;b.vid_id&&this.sendRequest({method:"VideoRecordedLive"},b,function(){})},BBCore.prototype.getVideoDeliveryUrl=function(a){return a=jQuery.extend({video_id:"",autoplay:1},a),"http://"+(this.getServerUrl().indexOf("dev")>0?"dev.":this.getServerUrl().indexOf("local")>0?"local.":"")+"bbemaildelivery.com/bbext/?p=video_land&id="+a.video_id+"&autoplay="+a.autoplay},BBCore.prototype.getVideo=function(a,b){a&&this.sendRequest({method:"GetVideos",video_id:a},b)},BBCore.prototype.getVideos=function(a,b){var c={updatedSince:"",page:null,pageSize:50};"function"==typeof a&&(b=a,a={});var d=jQuery.extend({},c,a);if("object"==typeof d&&null!=d&&void 0!==d.pageSize&&(null==d.pageSize||d.pageSize<=0||isNaN(d.pageSize)))return!1;d.method="GetVideos",null!==d.page&&d.pageSize&&(d.method="GetVideosPaged"),this.sendRequest(d,b)},BBCore.prototype.getVideoStatus=function(a,b){a&&this.sendRequest({method:"getVideoStatus",id:a},b)},BBCore.prototype.getEncodingReport=function(a,b){a&&this.sendRequest({method:"getEncodingReport",id:a},b)},BBCore.prototype.deleteVideo=function(a,b){this.sendRequest({method:"DeleteVideo",video_id:a},b)},BBCore.prototype.setVideoId=function(a){this.currentVideoId=a},BBCore.prototype.getVideoId=function(a){this.currentVideoId?a&&a.call(this,this.currentVideoId):this.getNewVideoGuid(a)},BBCore.prototype.hasVideoId=function(){return!!this.currentVideoId},BBCore.prototype.getNewVideoGuid=function(a){var b=this;this.sendRequest({method:"GetVideoGuid"},function(c){b.currentVideoId=c.info.video_id,a&&a.call(this,b.currentVideoId)})},BBCore.prototype.videoQuickSend=function(a,b){var c={method:"VideoQuickSend",subject:"QuickSend from BombBomb",mobile_message:"",email_address:null,videoId:null},d=[];for(var e in c)c.hasOwnProperty(e)&&(a[e]||(a[e]=c[e]));a.message&&!a.mobile_message&&(a.mobile_message=a.message),a.email&&!a.email_address&&(a.email_address=a.email),a.email_address&&!a.email_addresses&&(a.email_addresses=a.email_address),!a.video_id&&this.currentVideoId&&(a.video_id=this.currentVideoId),a.video_id||d.push("quickSendVideo Error: no video_id defined."),a.email_addresses||d.push("quickSendVideo Error: no email_address defined."),d.length>0&&!a.video_id?this.getVideoId(function(c){c?(a.video_id=c,this.sendRequest(a,b)):(d.push("quickSendVideo: Terminal Error: Unable to set video_id"),this.onError({info:{errmsg:d}}))}):this.sendRequest(a,b)},BBCore.contact=function(a){this.email="",this.firstname="",this.lastname="",this.phone="",this.phone_number="",this.address_line_1="",this.address_line_2="",this.city="",this.state="",this.country="",this.postal_code="",this.company="",this.position="",this.comments="",this.listlist="",this.id="";for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.eml=this.email},BBCore.video=function(a){this.vid_id="",this.title="",this.filename="";for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])};